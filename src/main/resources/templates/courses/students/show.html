<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header.html :: head}">

</head>
<body>

<div th:insert="~{fragments/navbar :: navbar}"></div>
    <form th:method="post" th:action="@{/courses/students}" th:object="${filterInfo}">
        <label class = "btn" th:text="${courseName}" />
        <select th:field="*{week}" id="week" style="width:40px;height:40px;margin-top:10px">
            <option th:value="${week}" th:text="${week}"/>
            <option th:each="week : ${#numbers.sequence(1,53)}" th:value="${week}" th:text="${week}"/>
        </select>
        <label class = "btn">주차</label>
        <select th:field="*{day}" id="day" style="width:40px;height:40px;margin-top:10px">
            <option th:value="${day}" th:text="${day}"/>
            <option th:each="day : ${#numbers.sequence(1,7)}" th:value="${day}" th:text="${day}"/>
        </select>
        <label class = "btn">일차</label>
        <button class="btn nav-btn" type="submit">조회</button>
    </form>
    <hr/>

<table class="table table-bordered" id="myTable">
    <thead class="thead-dark">
    <tr>
        <th></th>
        <div th:each="taskList : ${taskList}">
            <th><a href="/tasks/write.html" th:href="@{/tasks/{taskId}(taskId=${taskList.id})}" th:text="${taskList.title}"/></th>
        </div>
    </tr>
    </thead>
    <tbody>
    <!--학생이름 상태1, 상태2 순으로 뿌려줌-->
    <tr th:each="studentTask, stat : ${studentTaskList}">
        <td th:text="${studentTask.realName}"></td>
        <div th:each="status : ${studentTask.status}">
            <td id="test-td" class="test-td" th:attr="data-task_id=${status.taskId}, data-task_name=${status.taskName}" >
                <select id="status" th:value="${status.taskId}" onchange="changeStatus()" class="form-select" style="width:200px;height:40px;float:left" th:attr="data-task_id=${status.taskId},data-user_id=${studentTask.id}">
                    <option th:text="${status.taskStatus}"</option>
                    <option value="CREATED">CREATED</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="DONE">DONE</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </td>
        </div>
    </tr>
    </tbody>
</table>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script>
        // cell 클릭 시 해당 taskid, taskName 반환
        $(document).ready(function() {
            $('td').click(function(){
                var name = $('td').data('task_name');
                var tdindex = this.cellIndex;
                var trindex = $('tr').index($(this).parent())+1;
                var currentRow=$(this).closest("tr");

                var status = currentRow.find("td:eq("+tdindex+") select").val();

                var taskId = currentRow.find("td:eq("+tdindex+")").data('task_id');
                var taskName = currentRow.find("td:eq("+tdindex+")").data('task_name');


                alert("Row: "+trindex+" Column: "+ tdindex + "이름 : "  + taskName + " / " + "태스크아이디 : " + taskId + " / " + "상태 :  "+ status);
            });
        });

        function changeStatus() {
            //  userid, task
            let status = $('#status').val();
            let taskId = $("#status").data("task_id");
            let userId = $("#status").data("user_id");
            let sendData;
            $.ajax({
                type: 'POST',
                url: '/userTasks/sendUserTask',
                data: JSON.stringify(sendData)
                , contentType: 'application/json; charset=UTF-8'
                , success: function (res) {
                    // $("input:checkbox[id='check']").prop("checked", false); //체크박스 초기화
                    // window.location.href = res; // redirect
                }
            });
        }


    </script>
</body>



</html>

