<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header.html :: head}">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <title>Find Id</title>
</head>
<body>

  <div th:insert="~{fragments/navbar :: navbar}"></div>
  <p>이메일 인증을 하면 userName을 줌</p>
  <form th:method="post" th:action="@{/users/findId}">
    <div>
      <input type="email" id="email" name="email"/>
      <label>회원가입 때 사용하였던 이메일 인증을 통해 아이디를 알려드립니다.</label>
      <button onclick="send_email()" id="email_btn" type="button" data-toggle="modal" data-target="#staticBackdrop" disabled>인증하기</button>
    </div>
    <div>
      <button type="submit" id="find_btn" disabled>아이디 찾기</button>
    </div>
  </form>


  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" tabindex="-1"
       data-mdb-backdrop="static"
       data-mdb-keyboard="false" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">이메일 인증</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form method="post" action="/users/emailConfirm">
            <div class="form-outline mb-4" >
              <input type="text" class="form-control form-control-lg" name="code" th:id="code"/>
              <label class="form-label">회신된 이메일에서 코드를 적어주세요</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="confirm_email()">인증하기</button>
          <button type="button" class="btn btn-secondary" id="modal-close" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <script th:inline="javascript">
    let emailConfirm =false;
    let modalClose = document.getElementById("modal-close")
    let emailMode = "find"
    function send_email(){
      let email = $('#email').val();
      alert("해당 이메일로 인증코드를 보냈습니다. 인증코드를 확인해주세요!")
      $.ajax({
        type: 'POST',
        url: '/users/emailSend',
        data:{
          email: email
        }
      });
    }
    function confirm_email(){
      let code = $('#code').val();
      console.log(code)
      $.ajax({
        type: 'POST',
        url: '/users/emailConfirm',
        data:{
          code: code,
          check: emailMode
        },
        success : function (){
          modalClose.click()
          hide('emailFail')
          show('emailPass')
          alert("인증 성공")
          emailConfirm = true;
          document.getElementById("email_btn").setAttribute("disabled", "true")
        }
      })
    }
    function activate_find(){
      if(emailConfirm){
        document.getElementById("find_btn").removeAttribute("disabled")
      }
    }
  </script>
</body>
</html>